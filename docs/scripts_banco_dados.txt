CREATE DATABASE 'localhost:C:\ProjetosPaulo\ProjetoControleNegociacao\data\PROJETODELPHI.FDB.fdb'
USER 'SYSDBA' PASSWORD 'masterkey'
PAGE_SIZE 8192 DEFAULT CHARACTER SET UTF8;

CONNECT "C:\ProjetosPaulo\ProjetoControleNegociacao\data\PROJETODELPHI.FDB"
user 'SYSDBA' password 'masterkey';




CREATE GENERATOR GEN_CODPRODUTO;

CREATE TABLE TBL_PRODUTO (
  CODPRODUTO INTEGER NOT NULL,
  NOMEPRODUTO VARCHAR(100) NOT NULL,
  PRECOVENDAPRODUTO NUMERIC(15,2) NOT NULL,
  CONSTRAINT PK_TBL_PRODUTO PRIMARY KEY (CODPRODUTO)
);


CREATE GENERATOR GEN_CODDISTRIBUIDOR;

CREATE TABLE TBL_DISTRIBUIDOR (
  CODDISTRIBUIDOR INTEGER NOT NULL,
  NOMEDISTRIBUIDOR VARCHAR(100) NOT NULL,
  CNPJ VARCHAR(14) NOT NULL,
  CONSTRAINT PK_TBL_DISTRIBUIDOR PRIMARY KEY (CODDISTRIBUIDOR)
);

CREATE GENERATOR GEN_CODPRODUTOR;

CREATE TABLE TBL_PRODUTOR(
  CODPRODUTOR INTEGER NOT NULL, 
  NOMEPRODUTOR VARCHAR(100) NOT NULL,   
  CPF_CNPJ VARCHAR(14) NOT NULL,
  CONSTRAINT PK_TBL_PRODUTOR PRIMARY KEY (CODPRODUTOR)
);  

CREATE TABLE TBL_LIMITE_CREDITO(
  CODPRODUTOR INTEGER NOT NULL,  
  CODDISTRIBUIDOR INTEGER NOT NULL,  
  LIMITE_CREDITO NUMERIC(15,2) NOT NULL,
  CONSTRAINT PK_TBL_LIMITE_CREDITO PRIMARY KEY (CODPRODUTOR,CODDISTRIBUIDOR)  
  );


ALTER TABLE TBL_LIMITE_CREDITO ADD CONSTRAINT FK_TBL_PRODUTOR FOREIGN KEY (CODPRODUTOR) REFERENCES TBL_PRODUTOR(CODPRODUTOR);

ALTER TABLE TBL_LIMITE_CREDITO ADD CONSTRAINT FK_TBL_DISTRIBUIDOR FOREIGN KEY (CODDISTRIBUIDOR) REFERENCES TBL_DISTRIBUIDOR(CODDISTRIBUIDOR);

CREATE GENERATOR GEN_IDNEGOCIACAO;

CREATE TABLE TBL_NEGOCIACAO(
  IDNEGOCIACAO INTEGER NOT NULL,  
  CODPRODUTOR INTEGER NOT NULL,  
  CODDISTRIBUIDOR INTEGER NOT NULL,    
  STATUS VARCHAR(2) NOT NULL CHECK (STATUS IN ('PE', 'AP', 'CO', 'CA')), 
  DATA_NEGOCIACAO DATE NOT NULL,
  CONSTRAINT PK_TBL_NEGOCIACAO PRIMARY KEY (IDNEGOCIACAO)  
  );

ALTER TABLE TBL_NEGOCIACAO ADD CONSTRAINT FK2_TBL_PRODUTOR FOREIGN KEY (CODPRODUTOR) REFERENCES TBL_PRODUTOR(CODPRODUTOR);

ALTER TABLE TBL_NEGOCIACAO ADD CONSTRAINT FK2_TBL_DISTRIBUIDOR FOREIGN KEY (CODDISTRIBUIDOR) REFERENCES TBL_DISTRIBUIDOR(CODDISTRIBUIDOR);

CREATE TABLE TBL_NEGOCIACAO_ITENS(
  IDNEGOCIACAO INTEGER NOT NULL,  
  CODPRODUTO INTEGER NOT NULL,
  QUANTIDADE INTEGER NOT NULL
);  

ALTER TABLE TBL_NEGOCIACAO_ITENS ADD CONSTRAINT FK_TBL_NEGOCIACAO FOREIGN KEY (IDNEGOCIACAO) REFERENCES TBL_NEGOCIACAO(IDNEGOCIACAO);

ALTER TABLE TBL_NEGOCIACAO_ITENS ADD CONSTRAINT FK_TBL_PRODUTO FOREIGN KEY (CODPRODUTO) REFERENCES TBL_PRODUTO(CODPRODUTO);








// INSERT INTO TBL_PRODUTO(CODPRODUTO, NOMEPRODUTO, PRECOVENDAPRODUTO) VALUES(1,'ADUBO PARA CAPIM', 200);
// INSERT INTO TBL_PRODUTO(CODPRODUTO, NOMEPRODUTO, PRECOVENDAPRODUTO) VALUES(2,'DEFENSIVO PARA CAPIM', 180);

//INSERT INTO TBL_DISTRIBUIDOR(CODDISTRIBUIDOR, NOMEDISTRIBUIDOR, CNPJ) VALUES(1,'PAULO DISTRIBUIDOR', '12345678901234');
//INSERT INTO TBL_DISTRIBUIDOR(CODDISTRIBUIDOR, NOMEDISTRIBUIDOR, CNPJ) VALUES(2,'PAULO DISTRIBUIDOR 2', '12345678901234');

//INSERT INTO TBL_LIMITE_CREDITO(CODPRODUTOR,CODDISTRIBUIDOR,LIMITE_CREDITO) VALUES(1,1,1000);


//INSERT INTO TBL_NEGOCIACAO (IDNEGOCIACAO, CODPRODUTOR, CODDISTRIBUIDOR, STATUS, DATA_NEGOCIACAO)
//VALUES(GEN_ID(GEN_IDNEGOCIACAO, 1), 1, 1, 'PE', CURRENT_DATE);

//INSERT INTO TBL_NEGOCIACAO_ITENS(IDNEGOCIACAO , CODPRODUTO, QUANTIDADE) VALUES(1,1,10);
//INSERT INTO TBL_NEGOCIACAO_ITENS(IDNEGOCIACAO , CODPRODUTO, QUANTIDADE) VALUES(1,7,25);


SELECT * FROM TBL_PRODUTOR; (1,2)
SELECT * FROM TBL_DISTRIBUIDOR; (1,2,6,7)
SELECT * FROM TBL_PRODUTO (1,7,8,9)



SELECT L.CODPRODUTOR, P.NOMEPRODUTOR, L.CODDISTRIBUIDOR, D.NOMEDISTRIBUIDOR, L.LIMITE_CREDITO 
FROM TBL_LIMITE_CREDITO L
INNER JOIN TBL_PRODUTOR P     ON L.CODPRODUTOR     = P.CODPRODUTOR
INNER JOIN TBL_DISTRIBUIDOR D ON L.CODDISTRIBUIDOR = D.CODDISTRIBUIDOR;


SELECT D.CODDISTRIBUIDOR, D.NOMEDISTRIBUIDOR
FROM TBL_DISTRIBUIDOR D 
WHERE NOT EXISTS (SELECT * FROM TBL_LIMITE_CREDITO L
            WHERE L.CODDISTRIBUIDOR = D.CODDISTRIBUIDOR
			AND   L.CODPRODUTOR = 1);



SELECT N.IDNEGOCIACAO, 
       N.CODPRODUTOR, P.NOMEPRODUTOR, 
	   N.CODDISTRIBUIDOR, D.NOMEDISTRIBUIDOR,
	   N.STATUS, N.DATA_NEGOCIACAO,
	   (
	   SELECT SUM(I.QUANTIDADE * PO.PRECOVENDAPRODUTO)
	   FROM TBL_NEGOCIACAO_ITENS I 
	   INNER JOIN TBL_PRODUTO PO ON I.CODPRODUTO = PO.CODPRODUTO
	   WHERE I.IDNEGOCIACAO = N.IDNEGOCIACAO
	   ) AS TOTAL_NEGOCIACAO,
	   (
	   SELECT LIMITE_CREDITO
	   FROM TBL_LIMITE_CREDITO L
	   WHERE L.CODPRODUTOR = N.CODPRODUTOR
	   AND   L.CODDISTRIBUIDOR = N.CODDISTRIBUIDOR
	  ) AS LIMITE_CREDITO_CADASTRADO,
	  ( 
	   SELECT SUM(I.QUANTIDADE * PO.PRECOVENDAPRODUTO)
	   FROM TBL_NEGOCIACAO_ITENS I 
	   INNER JOIN TBL_PRODUTO PO ON I.CODPRODUTO = PO.CODPRODUTO	   
	   WHERE EXISTS (SELECT 1 FROM TBL_NEGOCIACAO N2 
	                 WHERE N2.CODPRODUTOR     = N.CODPRODUTOR
	                 AND   N2.CODDISTRIBUIDOR = N.CODDISTRIBUIDOR
                     AND   N2.IDNEGOCIACAO    = I.IDNEGOCIACAO
                     AND   N2.STATUS = 'AP'					 
					) 
	   
	   
	  ) AS VENDAS_APROVADAS	   
FROM TBL_NEGOCIACAO N
INNER JOIN TBL_PRODUTOR P     ON N.CODPRODUTOR     = P.CODPRODUTOR
INNER JOIN TBL_DISTRIBUIDOR D ON N.CODDISTRIBUIDOR = D.CODDISTRIBUIDOR;


6900

1 - QT 10 - 200
7 - QT 25 - 196

https://www.tiktok.com/@jadilinda














-------------------------------------------------------------------------------------------------




https://github.com/SiagriERPs/desafio_delphi_03

* * CADASTROS * * 
TBL_PRODUTOR(CODPRODUTOR, NOMEPRODUTOR, CPF_CNPJ_PRODUTOR)
TBL_LIMITE_CREDITO_PRODUTOR(CODPRODUTOR, CODDISTRIBUIDOR, LIMITE_CREDITO)
TBL_DISTRIBUIDOR(CODDISTRIBUIDOR, NOMEDISTRIBUIDOR, CNPJ)
TBL_PRODUTO(CODPRODUTO, NOMEPRODUTO, PRECOVENDAPRODUTO)

* * NEGOCIAÇÃO * * 
TBL_NEGOCIACAO(IDNEGOCIACAO, CODPRODUTOR, CODDISTRIBUIDOR, STATUS, DATA_NEGOCIACAO)
TBL_NEGOCIACAO_ITENS(IDNEGOCIACAO, CODPRODUTO, QUANTIDADE)





3 TELAS DE CADASTRO (PRODUTOR, DISTRIBUIDOR, PRODUTO)
1 TELA DE NEGOCIAÇÃO 
1 RELATORIO DE NEGOCIACAO



KEX1I58 
00787614092